---
title: "Final Project"
<<<<<<< .merge_file_UCNkPR
author: "
<table style='table-layout:fixed;width:100%;border:0;padding:0;margin:0'><col width='10%'><col width='10%'>
  <tr style='border:none'>
    <td style='display:block;width:100%;text-align:left;vertical-align:bottom;padding:0;margin:0;border:none' nowrap>
      <font style='font-style:normal'>Introduction to R</font><br>
      <a href='https://dwulff.github.io/Intro2R_Unibe/'>
        <i class='fas fa-clock' style='font-size:.9em;' ></i>
      </a>
      <a href='https://therbootcamp.github.io'>
        <i class='fas fa-home' style='font-size:.9em;'></i>
      </a>
      <a href='mailto:therbootcamp@gmail.com'>
        <i class='fas fa-envelope' style='font-size: .9em;'></i>
      </a>
      <a href='https://www.linkedin.com/company/basel-r-bootcamp/'>
        <i class='fab fa-linkedin' style='font-size: .9em;'></i>
      </a>
      <a href='https://therbootcamp.github.io'>
        <font style='font-style:normal'>Bern R Bootcamp</font>
      </a>
    </td>
    <td style='width:100%;vertical-align:bottom;text-align:right;padding:0;margin:0;border:none'>
      <img src='https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/by-sa.png' style='height:15px;width:80px'/>
    </td>
  </tr>
</table>"
=======
author: "Introduction to R<br/>
  <a href='https://therbootcamp.github.io'>
     Bern R Bootcamp
  </a> 
  <br>
  <a href='https://dwulff.github.io/Intro2R_Unibe/'>
    <i class='fas fa-clock' style='font-size:.9em;'></i>
  </a>&#8239; 
  <a href='https://therbootcamp.github.io'>
    <i class='fas fa-home' style='font-size:.9em;' ></i>
  </a>&#8239;
  <a href='mailto:therbootcamp@gmail.com'>
    <i class='fas fa-envelope' style='font-size: .9em;'></i>
  </a>&#8239;
  <a href='https://www.linkedin.com/company/basel-r-bootcamp/'>
    <i class='fab fa-linkedin' style='font-size: .9em;'></i>
  </a>"
>>>>>>> .merge_file_vDTQVH
output:
  html_document:
    css: practical.css
    self_contained: no
---

<<<<<<< .merge_file_UCNkPR
=======

>>>>>>> .merge_file_vDTQVH
```{r setup, echo = FALSE}
knitr::opts_chunk$set(comment = NA, 
                      fig.width = 6, 
                      fig.height = 6,
                      fig.align = 'center',
<<<<<<< .merge_file_UCNkPR
                      echo = FALSE, 
                      eval = FALSE, 
                      warning = FALSE)

options(digits = 3)
library(tidyverse)
library(lubridate)
=======
                      echo = TRUE, 
                      eval = TRUE, 
                      warning = FALSE)

options(digits = 3)
>>>>>>> .merge_file_vDTQVH
```

<p align="center">
<img width="100%" src="https://meetville.com/blog/wp-content/uploads/2015/01/imgonline-com-ua-Resize-quU8YQt7HJLDQEjt.jpg" margin=0><br>
<font style="font-size:10px">adapted from [meetville.com](https://meetville.com/blog/wp-content/uploads/2015/01/imgonline-com-ua-Resize-quU8YQt7HJLDQEjt.jpg)</font>
</p>


# {.tabset .tabset-fade}

## Overview

This is your final assignment in this course. You will use all we learned during the course to understand, arrange, analyse, visualise and report on a new dataset about medical appointments.

What is the dataset about? There is a large number of medical appointments where patients end up canceling or simply do not show up. This practise comes with costs to the medical system - in this assignment we will try to understand what drives patients not to show up in a sample of medical appointments from (Brasil).

From the given list of parameters, such as Gender, Scheduled and Appointment Date difference, Age, Neighbourhood, sms_alert and certain conditions of a given patient, the model will predict, based on a studied dataset, whether the given appointment is likely to be a No-Show

You should (at least) complete the following tasks

1. load the two .csv files you find in `Datasets` into R objects 
2. 

## Tasks

### A - Setup

1. Open your `bernrbootcamp` R project. It should already have the folders `1_Data` and `2_Code`. Make sure that the data files listed in the `Datasets` section above are in your `1_Data` folder.

2. Open a new R script. At the top of the script, using comments, write your name and the date. Save it as a new file called `final_project.R` in the `2_Code` folder.  

3. Using `library()` load the set of packages for this practical listed in the packages section above.

4. Read the `appointments.csv` and the `weather.csv` files into two objects called `appointments` and `weather` respectively. Check out the content of the two datasets in Overview and Datasets above.

```{r, echo = FALSE, eval = FALSE, message = FALSE, warning = FALSE}
appointments <- read_csv('1_Data/medical_noshows.csv')
weather <- read_csv('1_Data/weather.csv')
```

### B - Initial data inspection

1. We want to first see what variables are in the dataset (check out Datasets above) and whether there are variables with impossible values. Generate an overview of all variables with minimum and maximum values, means and medians for all appropriate numeric variables. Correct the variable(s) that stand out and provide a rational for what you did.
Also rename Hipertension into Hyptertension and Handcap into Handicap.

```{r, echo = TRUE, eval = FALSE, message = FALSE, warning = FALSE}
summary(appointments)

appointments <-
appointments %>%
  filter(Age >= 0) %>%
  rename('Hypertension' = 'Hipertension',
         'Handicap' = 'Handcap')
```

2. How many patients showed up for their appointment(s), how many did not?

```{r, echo = TRUE, eval = FALSE, message = FALSE, warning = FALSE}
table(appointments$NoShow)
```

3. How many patients are female|male? Who (PatientID) has the most number of appointments? Split that for gender.

```{r, echo = TRUE, eval = FALSE, message = FALSE, warning = FALSE}
  appointments %>%
    group_by(PatientId,Gender) %>%
    count(unique(PatientId)) %>%
    arrange(desc(n))
```

4. Generate a simple plot with the age of all patients. 

```{r}
  ggplot(appointments, aes(PatientId, Age)) +
  geom_point(alpha = 0.5) 
```

5. Summarise the number of particiants per age in years (range: ```range(appointments$Age)```) for the whole `appointments` dataset. Generate a line graph showing the distribution of patients per age. Now split this graph into two rows with  Female|Male and two columns with Show|No-Show - this will give you an age distribution with four panels.

```{r}
  appointments %>%
  group_by(Age, Gender, NoShow) %>%
  summarise(size = n()) %>%
  ggplot(., aes(Age, size)) +
  geom_line() +
  facet_grid(Gender ~ NoShow)
```

6. Generate a new variable `age_group` which includes four groups [1:4] where 1: 'children' between 0 and 18 years, 2:  'young adults' between 19 and 30 years, 3: 'adults' (31:50 years) and 4 'old adults' (51:max(Age)) 


```{r, eval = TRUE}
  appointments <- 
  appointments %>%
    mutate(age_group = case_when(Age %in% c(0:18) ~ 'children',
                                 Age %in% c(19:30) ~ 'young adults',
                                 Age %in% c(31:50) ~ 'adults',
                                 Age %in% c(51:max(Age)) ~ 'old adults'))

```

<<<<<<< .merge_file_UCNkPR
7. Plot the four age groups on the x-axis and the size of the groups on the y-axis (call this variable: number_cases). Connect the points ina line graph, separated for gender. Facet the graph into two parts, with noshow 'No' on top and nowshow 'Yes' on bottom. So ultimately you should have 4 lines, 2 in each panel. 
=======
7. 
>>>>>>> .merge_file_vDTQVH

```{r}
  appointments %>%
  group_by(age_group, Gender, NoShow) %>%
<<<<<<< .merge_file_UCNkPR
  summarise(number_cases = n()) %>%
  ggplot(., aes(age_group, size, colour = Gender, group = Gender)) +
  geom_line() +
  facet_grid(NoShow ~ .)
```

8. We want to explore the time difference between making an appointment and actually having an appointment a little more. Using the `lubridate()` package extract Year-Month-Day from `ScheduledDay` and write this date information (without time) into a new variable `ScheduledDate` (Hint: `date()` ). Convert `AppointmentDay` to the date class, too. We want to get the distribution of time between scheduled appointment date and actual appointment day - write this difference (in days) in a new variable called `time_diff`. There are some appointments with a negative `time_diff`. We assume that these are based on typos - remove them from the dataset.

```{r}
appointments <- 
appointments %>%
  mutate(ScheduledDate = date(ScheduledDay)) %>%
  mutate(AppointmentDay = date(AppointmentDay)) %>%
  mutate(time_diff = AppointmentDay - ScheduledDate) %>%
  filter(!time_diff < 0)
```

```{r, echo = TRUE, eval = TRUE}
dim(appointments)
```


9. Categorize lead days

```{r}
appointments <- 
appointments %>%
  mutate(lead_days = case_when(time_diff == 0 ~ '0 days',
                               time_diff %in% c(1:2) ~ '1-2 days',
                               time_diff %in% c(3:7) ~ '3-7 days',
                               time_diff %in% c(8:31) ~ '8-31 days',
                               time_diff %in% c(32:max(time_diff)) ~ '32+ days'))
```
0
1-2
3-7
8-31
32+

### C - 

### D - Mapping out locations
=======
  summarise(size = n()) %>%
  ggplot(., aes(age_group, size, colour = Gender, group = Gender)) +
  geom_point() +
  facet_grid(NoShow ~ .)
```

D - Mapping out locations
>>>>>>> .merge_file_vDTQVH

1. From the `weather` dataframe take the lon and lat coordinates and setup a dot for each location on the map of Brasil. Any inconsistencies? Hint: Checkout `qmplot()` from the `ggmap` package. 

```{r, eval = TRUE, message = FALSE}
qmplot(LON, LAT, data = weather, maptype = "toner-lite", color = I("red"))
```

2. There is a set of points off the coast of Brasil in the water - identify those points and remove them from the dataset.

3. 

## Datasets

```{r, eval = TRUE, message = FALSE}
library(tidyverse)
appointments <- read_csv('1_Data/medical_noshows.csv')
weather <- read_csv('1_Data/weather.csv')
```

|File | Rows | Columns | Description |
|:----|:-----|:------|:-----------------------------------------|
|[medical_noshows.csv](1_Data/medical_noshows.csv) | 110527 | 14| Patient shows|no-shows for various cities in Brasil |
|[brazil_wheather.csv](1_Data/weather_per_coordinate.csv) | 2255 | 10| Weather data for various longitute and latitude coordinates in Brasil |

### Variables in medical_noshows.csv (appointments)

|Variable | Description |
|:--------|:-----------------------------|
|PatientId | ID of a patient |
|AppointmentID | ID for each appointment |
|Gender | Male or Female|
|ScheduledDay | The day of the actual appointment, when patients have to visit the doctor |
|AppointmentDay | The day someone called or registered the appointment, this should be before the appointment|
|Age | How old is the patient|
|Neighbourhood | Where the patient is living|
|Hipertension | True or False |
|Diabetes | True or False |
|Alcoholism | True or False |
|Handcap | Hanicapped - level 1:4, 1 lowest level |
|SMS_received | True: 1 or more messages sent to the patient|
|No-show | 1: No, 2: Yes|

### Variables in brazil_wheather.csv (weather)

|Variable | Description |
|:--------|:-----------------------------|
|LON  |Longitude|
|LAT  |Latitude|
|YEAR  |Year| 
|MM    |Month|
|DD   |Day|
|DOY |Day of Year|
|YYYYMMDD|Date|    
|RH2M   |Relative Humidity at 2 Meters|
|T2M |Temperature at 2 Meters|
|PRECTOT|Precipitation|


## Packages

|Package| Installation|
|:------|:------|
|`tidyverse`|`install.packages("tidyverse")`|
|`lubridate`|`install.packages("lubridate")`|
|`tidylog`|`devtools::install_github("elbersb/tidylog")`|

## Glossary (UPDATE!)

*Wrangling*

| Function| Package | Description |
|:---|:------|:---------------------------------------------|
|     `rename()`|`dplyr`|    Rename columns| 
|     `select()`|`dplyr`|    Select columns based on name or index| 
|     `filter()`|`dplyr`|    Select rows based on some logical criteria| 
|     `arrange()`|`dplyr`|    Sort rows| 
|     `mutate()`|`dplyr`|    Add new columns|
|     `case_when()`|`dplyr`|    Recode values of a column| 
|     `group_by(), summarise()`|`dplyr`|   Group data and then calculate summary statistics|
|     `left_join()`|`dplyr`|   Combine multiple data sets using a key column|
|     `spread()`|`tidyr`|    Convert long data to wide format - from rows to columns| 
|     `gather()`|`tidyr`|    Convert wide data to long format - from columns to rows|

*Statistical Tests*

| Function| Hypothesis Test|
|:------|:-------------------|
|     `t.test()`|    One and two sample t-test|
|     `cor.test()`|    Correlation test|
|     `glm()`, `lm()`|    Generalized linear model and linear model|

## Cheatsheets

<figure>
<center>
<a href="https://github.com/rstudio/cheatsheets/raw/master/data-transformation.pdf">
  <img src="https://www.rstudio.com/wp-content/uploads/2018/08/data-transformation-600x464.png" alt="Dplyr" style="width:70%">
  <figcaption>https://github.com/rstudio/cheatsheets/raw/master/data-transformation.pdf</figcaption></a>
</figure>

<figure>
<center>
<a href="https://github.com/rstudio/cheatsheets/raw/master/lubridate.pdf">
  <img src="https://www.rstudio.com/wp-content/uploads/2018/08/lubridate-600x464.png" alt="Lubridate" style="width:70%">
  <figcaption>https://github.com/rstudio/cheatsheets/raw/master/lubridate.pdf</figcaption></a>
</figure>
