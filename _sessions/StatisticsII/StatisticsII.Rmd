---
title: "Statistics II"
author: "
Introduction to R<br>
  <a href='https://therbootcamp.github.io'>
    Bern R Bootcamp
  </a>
  <br>
  <a href='https://dwulff.github.io/Intro2R_Unibe/'>
    <i class='fas fa-clock' style='font-size:.9em;'></i>
  </a>&#8239; 
  <a href='https://therbootcamp.github.io'>
    <i class='fas fa-home' style='font-size:.9em;' ></i>
  </a>&#8239;
  <a href='mailto:therbootcamp@gmail.com'>
    <i class='fas fa-envelope' style='font-size: .9em;'></i>
  </a>&#8239;
  <a href='https://www.linkedin.com/company/basel-r-bootcamp/'>
    <i class='fab fa-linkedin' style='font-size: .9em;'></i>
  </a>"
date: "February 2019"
output:
  xaringan::moon_reader:
    css: ["default", "baselrbootcamp.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: '16:9'
---

layout: true

<div class="my-footer">
  <span style="text-align:center">
    <span> 
      <img src="https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/by-sa.png" height=14 style="vertical-align: middle"/>
    </span>
    <a href="https://therbootcamp.github.io/">
      <span style="padding-left:82px"> 
        <font color="#7E7E7E">
          www.therbootcamp.com
        </font>
      </span>
    </a>
    <a href="https://therbootcamp.github.io/">
      <font color="#7E7E7E">
       Introduction to R | February 2019
      </font>
    </a>
    </span>
  </div> 

---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
# see: https://github.com/yihui/xaringan
# install.packages("xaringan")
# see: 
# https://github.com/yihui/xaringan/wiki
# https://github.com/gnab/remark/wiki/Markdown

  
options(max.print = 20)
options(width=110)
options(digits = 4)
library(tidyverse)

baselers <- read_csv("https://raw.githubusercontent.com/therbootcamp/baselers/master/inst/extdata/baselers.txt")

source("https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_materials/code/baselrbootcamp_palettes.R")

set.seed(102)
x <- rnorm(10)
y <- .7 * x + rnorm(10, sd = .3) + 2

data <- data.frame(x, y)
mod <- lm(y ~ x, data = data)

mediocre_intercept <- 2.5
mediocre_slope <- -.2
dat_medi <- data.frame(x0 = x, x1 = x,
                           y0 = y, y1 = mediocre_intercept + mediocre_slope * x)

bad_intercept <- 3.5
bad_slope <- -.5
dat_bad <- data.frame(x0 = x, x1 = x,
                      y0 = y, y1 = bad_intercept + bad_slope * x)

great_intercept <- mod$coefficients[1]
great_slope <- mod$coefficients[2]
dat_great <- data.frame(x0 = x, x1 = x,
                        y0 = y, y1 = great_intercept + great_slope * x)


# raw plot
raw <- ggplot(dat_great, aes(x = x0, y = y0)) + geom_point(col = baselrbootcamp_cols("grey"), size = 2) +
  theme_minimal() + xlim(c(-2, 3)) + ylim(c(0, 5)) +
  labs(subtitle = 'How to best explain these point?',
       x = "Predictor", y = "Criterion")


medi_raw <- ggplot(dat_medi, aes(x = x0, y = y0)) + geom_point(col = baselrbootcamp_cols("grey"), size = 2) +
  geom_abline(slope = mediocre_slope, intercept = mediocre_intercept, size = .5, linetype = 3) +
  theme_minimal() + xlim(c(-2, 3)) + ylim(c(0, 5)) +
  labs(subtitle = paste("Is this a good fit?"), x = "Predictor", y = "Criterion")


great_raw <- ggplot(dat_great, aes(x = x0, y = y0)) + geom_point(col = baselrbootcamp_cols("grey"), size = 2) +
  geom_abline(slope = great_slope, intercept = great_intercept, size = .5, linetype = 3) +
  theme_minimal() + xlim(c(-2, 3)) + ylim(c(0, 5)) +
  labs(subtitle = paste("Or this?"), x = "Predictor", y = "Criterion")


bad_raw <- ggplot(dat_bad, aes(x = x0, y = y0)) + geom_point(col = baselrbootcamp_cols("grey"), size = 2) +
  geom_abline(slope = bad_slope, intercept = bad_intercept, size = .5, linetype = 3) +
  theme_minimal() + xlim(c(-2, 3)) + ylim(c(0, 5)) +
  labs(subtitle = paste("Or this?"), x = "Predictor", y = "Criterion")

medi_err <- medi_raw + 
  geom_linerange(data = dat_medi, aes(x = x0, ymin = y0, ymax = y1), col = baselrbootcamp_cols("magenta")) +
  geom_point(data = dat_medi, aes(x = x0, y = y1, size = 2), col = baselrbootcamp_cols("green"), pch = "X", size = 4) +
    labs(subtitle = paste("Mean Squared Error (MSE) = ", round(mean((dat_medi$y1 - dat_medi$y0) ^ 2), 2)),
       x = "Predictor", y = "Criterion")

great_err <- great_raw + 
  geom_linerange(data = dat_great, aes(x = x0, ymin = y0, ymax = y1), col = baselrbootcamp_cols("magenta")) +
  geom_point(data = dat_great, aes(x = x0, y = y1, size = 2), col = baselrbootcamp_cols("green"), pch = "X", size = 4) +
    labs(subtitle = paste("Mean Squared Error (MSE) = ", round(mean((dat_great$y1 - dat_great$y0) ^ 2), 2)),
       x = "Predictor", y = "Criterion")

bad_err <- bad_raw +
    geom_linerange(data = dat_bad, aes(x = x0, ymin = y0, ymax = y1), col = baselrbootcamp_cols("magenta")) +
    geom_point(data = dat_bad, aes(x = x0, y = y1, size = 2), col = baselrbootcamp_cols("green"), pch = "X", size = 4) +
   labs(subtitle = paste("Mean Squared Error (MSE) = ", round(mean((dat_bad$y1 - dat_bad$y0) ^ 2), 2)),
       x = "Predictor", y = "Criterion")

knitr::opts_chunk$set(warning = FALSE)

```

.pull-left5[

# Linear models


#### <high>Run linear models</high> with `stats` including...

<table>
  <tr>
    <td> <b>Function</b> </td>
    <td> <b>Purpose</b> </td>
  </tr>
  <tr>
    <td> <mono>lm()</mono>, <mono>glm()</mono> </td>
    <td> (Generalized) linear models </td>
  </tr>
  <tr>
    <td> <mono>lmer()</mono>, <mono>glmer()</mono> </td>
    <td> (Generalized) mixed-linear models </td>
  </tr>
  <tr>
    <td> <mono>stan_glm()</mono> </td>
    <td> Bayesian (gen.) linear models </td>
  </tr>
</table>

#### <high>Explore linear models</high> with `stats`


<table>
  <col width="43%">
  <col width="57%">
  <tr>
    <td> <b>Function</b> </td>
    <td> <b>Purpose</b> </td>
  </tr>
  <tr>
    <td> <mono>summary()</mono>, <mono>print()</mono>, <mono>coefficients()</mono></td>
    <td> Inspect fitted coefficients </td>
  </tr>
  <tr>
    <td> <mono>names()</mono>, <mono>mod$name</mono> </td>
    <td> Inspect model object </td>
  </tr>
  <tr>
    <td> <mono>plot()</mono> </td>
    <td> Inspect default illustrations </td>
  </tr>
</table>

]

.pull-right45[

<p align = "center">
<br><br>
<img src="image/curve_fitting_sm.png" height=500px><br>
<font style="font-size:10px">adapted from <a href="https://xkcd.com/892/">xkcd.com</a></font>
</p>
]



---

# Fitting a linear model

<p align="center">
```{r, echo = FALSE, fig.width = 4.4, fig.height = 2.6, dpi = 400, out.width = "80%"}
raw
```
</p>

---

# Fitting a linear model

<p align="center">
```{r, echo = FALSE, fig.width = 4.4, fig.height = 2.6, dpi = 400, out.width = "80%"}
medi_raw
```
</p>

---

# Fitting a linear model

<p align="center">
```{r, echo = FALSE, fig.width = 4.4, fig.height = 2.6, dpi = 400, out.width = "80%"}
bad_raw
```
</p>

---

# Fitting a linear model

<p align="center">
```{r, echo = FALSE, fig.width = 4.4, fig.height = 2.6, dpi = 400, out.width = "80%"}
great_raw
```
</p>


---

# Fitting a linear model

<p align="center">
```{r, echo = FALSE, fig.width = 4.4, fig.height = 2.6, dpi = 400, out.width = "80%"}
medi_err
```
</p>


---

# Fitting a linear model

<p align="center">
```{r, echo = FALSE, fig.width = 4.4, fig.height = 2.6, dpi = 400, out.width = "80%"}
bad_err
```
</p>

---

# Fitting a linear model

<p align="center">
```{r, echo = FALSE, fig.width = 4.4, fig.height = 2.6, dpi = 400, out.width = "80%"}
great_err
```
</p>

---

# Basic structure of statistical functions

.pull-left3[

Statistical functions work with two types of objects... 


(1) A <high>`tibble`</high> in place of the `data` argument.

(2) A <high>`formula`</high> in place of the `formula` argument.

<br>
<high>`Formulas`</high> specifies a <high>criterion</high> (y) as a function of one or more <high>predictors</high> (x1, x2, ...) in the form:

<mono>formula = y ~ x1 + x2 +...<mono>

]

.pull-right65[

```{r}
# Example: Create regression object (my_glm)
my_glm <- glm(formula = income ~ age + height,
              data = baselers)
```

<p align="center">
<img src="https://raw.githubusercontent.com/therbootcamp/Erfurt_2018June/master/_sessions/_image/formula_description.png">
</p>

]

---
 
.pull-left35[

 # Look for optional arguments

Statistical functions usually have many optional arguments.

Each of these have <high>default</high> values. To customise a test, <high>look at the help menu</high> and specify arguments explicitly.

]


.pull-right6[

<br><br>

<u>Default vs. customised `glm()` (Generalized linear model)</u>
```{r, eval = FALSE}
# Default
glm(formula = income ~ age + education,
    data = baselers)

# Customised
glm(formula = eyecor ~ age + education,
    data = baselers,
    family = "binomial")  # Logistic regression
```

<u>Default vs. customised `t-test`</u>

```{r, eval = FALSE}
# Default
t.test(formula = age ~ sex,
       data = baselers)

# Customised
t.test(formula = age ~ sex,
       data = baselers,
       alternative = "less", # One sided test
       var.equal = TRUE)     # Assume equal variance
```

]


---
 
.pull-left35[

 # Look for optional arguments

```{r}
?glm
```

<p align="center">
  <img src="https://raw.githubusercontent.com/therbootcamp/Erfurt_2018June/master/_sessions/_image/glm_help.jpg">
</p>

]


.pull-right6[

<br><br>

<u>Default vs. customised `glm()` (Generalized linear model)</u>
```{r, eval = FALSE}
# Default
glm(formula = income ~ age + education,
    data = baselers)

# Customised
glm(formula = eyecor ~ age + education,
    data = baselers,
    family = "binomial")  # Logistic regression
```

<u>Default vs. customised `t-test`</u>

```{r, eval = FALSE}
# Default
t.test(formula = age ~ sex,
       data = baselers)

# Customised
t.test(formula = age ~ sex,
       data = baselers,
       alternative = "less", # One sided test
       var.equal = TRUE)     # Assume equal variance
```

]



---


# Regression with `glm()`, `lm()`

.pull-left35[

How to <high>create a regression model</high> predicting, e.g., how much money people spend on `food` as a function of `income`?

<br>
Part of the `baselers` dataframe:

.pull-left6[

```{r, echo = FALSE}
baselers %>% 
  select(food, income, happiness) %>%
  slice(1:5) %>% 
  knitr::kable(format = "markdown")
```

]
<!-- $$\Large food = \beta_{0} + \beta_{1} \times Inc + \beta_{1} \times Hap+ \epsilon$$ -->

]

.pull-right6[

### Generalized regression with `glm()`

```{r}
# food (y) on income (x1) and happiness (x2)
food_glm <- glm(formula = food ~ income + happiness,
              data = baselers)

# Print food_glm
food_glm
```

]


---

# Customising formulas

Include additional independent variables to formulas by "adding" them with <high>`+`</high> 

```{r}
# Include multiple terms with +
my_glm <- glm(formula = income ~ food + alcohol + happiness + hiking,
              data = baselers)
```

To <high>include all variables</high> in a dataframe, use the catch-all notation <high>`formula = y ~ .`</high>

```{r}
# Use  y ~ . to include ALL variables
my_glm <- glm(formula = income ~ .,
              data = baselers)
```

To include <high>interaction terms</high> use `x1 : x2` or  `x1 * x2` (also includes main effects) instead of `x1 + x2`

```{r}
# Include an interaction term between food and alcohol
my_glm <- glm(formula = income ~ food * alcohol,
              data = baselers)
```

---

# Exploring statistical objects

.pull-left35[

Explore statistical objects using <high>generic</high> functions such as `print()`, `summary()`, `predict()` and `plot()`.

<high>Generic</high> functions different things depending on the <high>class label</high> of the object. 

```{r, eval = FALSE}
# Create statistical object
obj <- STAT_FUN(formula = ...,
                data = ...)

names(obj)       # Elements
print(obj)       # Print
summary(obj)     # Summary
plot(obj)        # Plotting
predict(obj, ..) # Predict
```

]

.pull-right6[

```{r, eval = TRUE}
# Create a glm object
my_glm <- glm(formula = income ~ happiness + age,
              data = baselers)

# print the my_glm object
print(my_glm)
```

]



---

# Exploring statistical objects

.pull-left35[

Explore statistical objects using <high>generic</high> functions such as `print()`, `summary()`, `predict()` and `plot()`.

<high>Generic</high> functions different things depending on the <high>class label</high> of the object. 

```{r, eval = FALSE}
# Create statistical object
obj <- STAT_FUN(formula = ...,
                data = ...)

names(obj)       # Elements
print(obj)       # Print
summary(obj)     # Summary
plot(obj)        # Plotting
predict(obj, ..) # Predict
```

]

.pull-right6[

```{r, eval = TRUE}
# Create a glm object
my_glm <- glm(formula = income ~ happiness + age,
              data = baselers)

# Show summary of the my_glm object
summary(my_glm)
```

]


---

# Exploring statistical objects

.pull-left35[

Explore statistical objects using <high>generic</high> functions such as `print()`, `summary()`, `predict()` and `plot()`.

<high>Generic</high> functions different things depending on the <high>class label</high> of the object. 

```{r, eval = FALSE}
# Create statistical object
obj <- STAT_FUN(formula = ...,
                data = ...)

names(obj)       # Elements
print(obj)       # Print
summary(obj)     # Summary
plot(obj)        # Plotting
predict(obj, ..) # Predict
```

]

.pull-right6[

Many <high>statistical objects are lists</high>. Show elements with `names()`, access them with <high>`$`</high>.

```{r, eval = FALSE}
# What are the named elements
names(my_glm)
```
 
```{r, echo = FALSE}
# What are the named elements
names(my_glm)[1:10]
``` 
 
<p align="left">
  <img src="https://raw.githubusercontent.com/therbootcamp/Erfurt_2018June/master/_sessions/_image/list_tab.png" height="180px" vspace="10px">
</p>
 

]


---

# Exploring statistical objects

.pull-left35[

Explore statistical objects using <high>generic</high> functions such as `print()`, `summary()`, `predict()` and `plot()`.

<high>Generic</high> functions different things depending on the <high>class label</high> of the object. 

```{r, eval = FALSE}
# Create statistical object
obj <- STAT_FUN(formula = ...,
                data = ...)

names(obj)       # Elements
print(obj)       # Print
summary(obj)     # Summary
plot(obj)        # Plotting
predict(obj, ..) # Predict
```

]

.pull-right6[


```{r, eval = FALSE}
# Look at coefficients
my_glm$coefficients
```

```{r, echo = FALSE}
# Look at coefficients
my_glm$coefficients
```

```{r, eval = FALSE}
# First 5 fitted values
my_glm$fitted.values
```

```{r, echo = FALSE}
# First 5 fitted values
my_glm$fitted.values[1:8]
```

```{r, eval = FALSE}
# First 5 residuals
my_glm$residuals
```

```{r, echo = FALSE}
# First 5 residuals
my_glm$residuals[1:6]
```

]


---

# `predict()`

.pull-left4[

`predict(model, newdata)` allows you to use your `model` to <high>predict outcomes</high> for `newdata`.

```{r, echo = FALSE}
lastyear <- baselers %>% slice(1:100)
thisyear <- baselers %>% slice(101:200)
```

```{r, eval = FALSE}
last_year
```

```{r, echo = FALSE}
lastyear  %>% select(id, age, fitness, tattoos, income) %>% 
  slice(1:2) %>% knitr::kable(format = "markdown")
```

```{r, echo = TRUE, eval = FALSE}
this_year
```


```{r, echo = FALSE}
thisyear  %>% select(id, age, fitness, tattoos) %>% slice(1:2) %>% mutate(income = NA) %>% knitr::kable(format = "markdown")
```


]


.pull-right55[

<high>Fit `model`</high> based on `leastyear`

```{r}
# Create regression model predicting income
model <- lm(formula = income ~ age + tattoos,
            data = lastyear)

model$coefficients
```

Now use `model` to <high>`predict`</high> values for `thisyear`

```{r, eval = FALSE, echo = TRUE}
# Predict the income of people in thisyear
predict(object = model, 
        newdata = thisyear)
```

```{r, eval = TRUE, echo = FALSE}
# Predict the income of people in thisyear
predict(object = model, 
        newdata = thisyear)[1:2]
```

]


---

.pull-left4[

# `tidy()`

The `tidy()` function from the `broom` package <high>converts</high> the most important results of many statistical object like "glm" to a <high>data frame</high>.

```{r, eval = FALSE}
# install and load broom
install.packages('broom')
library(broom)
```

<p align="center">
  <img src="https://raw.githubusercontent.com/therbootcamp/Erfurt_2018June/master/_sessions/_image/broom_hex.png" height="200px" vspace="10">
</p>


]

.pull-right55[

<br><br>

```{r}
# Original printout
my_glm
```

```{r, echo = FALSE, message=F,warning=F}
# Tidy printout
require(broom)
```

```{r}
# Tidy printout
tidy(my_glm)
```

]

---


.pull-left4[

# Other great statistics packages

<br>

|package|Description|
|:----|:-----|
|`afex`|Factorial experiments|
|`lme4`|Mixed effects models|
|`rstanarm`|Bayesian mixed effects models|
|`BayesFactor`|Bayesian Models|
|`forecast`|Time series| 
|`lavaan`|Latent variable and structural equation modelling| 


]


.pull-right55[

<br><br>

<p align="center">
  <img src="https://raw.githubusercontent.com/therbootcamp/Erfurt_2018June/master/_sessions/_image/BayesFactor_ss.png" height= "120px">
</p>

<p align="center">
  <img src="https://raw.githubusercontent.com/therbootcamp/Erfurt_2018June/master/_sessions/_image/lavaan_ss.jpg" height= "320px" vspace="35px">
</p>

]

---

# Summary

.pull-left45[

1 - There are <high>packages for every statistical procedure</high> you can imagine in R.

2 - Most have <high>formula</high> and <high>data</high> arguments (among many others).

3 - Use <high>help files</high> to understand the arguments of functions!

4 - Once you've created a statistical object, use <high>generic functions</high> to explore it: `print()`, `names()`, `summary()`, etc.

5 - Use <high>random sampling</high> functions to run simulations.

]

.pull-right5[

```{r, eval = F}
?t.test
```

<p align="left">
  <img src="https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/ttesthelp_ss.png" height= "380px" >
</p>

]

---

# Stats? There is a package for that!


## REMOVE

.pull-left45[

<br>

| Package| Models|
|------:|:----|
| `stats`|Generalized linear model|
|     `afex`|   Anovas|
|     `lme4`|   Mixed effects regression|
|     `rpart`|    Decision Trees|
|     `BayesFactor`| Bayesian statistics|
|     `igraph`| Network analysis|
|     `neuralnet`| Neural networks|
|     `MatchIt`| Matching and causal inference|
|     `survival`| Longitudinal survival analysis|
|     ...| Anything you can ever want!|



]

.pull-right5[

<p align="center">
  <img src="https://raw.githubusercontent.com/therbootcamp/therbootcamp.github.io/master/_sessions/_image/statistical_procedures.png" height="450px" vspace="20">
</p>

]




---

# Practical

<p>
  <font size=6>
    <a href="https://therbootcamp.github.io/BaselRBootcamp_2018July/_sessions/Statistics/Statistics_practical.html"><b>Link to practical<b></a>
  </font>
</p>

